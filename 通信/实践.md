## 实践
## 父应用全局状态声明与传递
1. 主应用中注册`main/src/globalState.js`，用于管理全局状态。

```js
import { initGlobalState } from "qiankun";
import Vue from "vue";

// Vue.observable是为了让initialState变成可响应：https://cn.vuejs.org/v2/api/#Vue-observable。
let initialState = Vue.observable({
  userInfo: {},
});

const actions = initGlobalState(initialState);

actions.onGlobalStateChange((newV, oldV) => {
  console.log("main change", JSON.stringify(newV), JSON.stringify(oldV));
  for (let key in newV) {
    initialState[key] = newV[key];
  }
});

// 自定义方法用于获取state
actions.getGlobalState = (key) => {
  return key ? initialState[key] : initialState;
};

export default actions;
```

2. 将`getGlobalState`方法传递给子应用。

```js
// microApps.js

import globalState from "./globalState";
microApps = microApps.map((item) => {
  return {
    ...item,
    container: "#subapp-viewport",
    props: {
      routerBase: item.activeRule,
      getGlobalState: globalState.getGlobalState,
    },
  };
});
```

3. 在`main.js`中引入，挂在`vue`原型链上。

```js
import globalState from "./globalState";

Vue.prototype.$globalState = globalState;
```



## 子应用状态声明与传递

### vue

1. 声明一个`src/store/globalState.js`用于声明全局状态，使用`vuex`隔离状态变更。

```js
/**
 *
 * @param {vuex实例} store
 * @param {qiankun下发的props} props
 */
function registerGlobalModule(store, props = {}) {
  if (!store || !store.hasModule) {
    return;
  }

  // 获取初始化的state
  const initState = (props.getGlobalState && props.getGlobalState()) || {
    userInfo: [],
  };

  // 将父应用的数据存储到子应用中，命名空间固定为global
  if (!store.hasModule("global")) {
    const globalModule = {
      namespaced: true,
      state: initState,
      actions: {
        // 子应用改变state并通知父应用
        setGlobalState({ commit }, payload) {
          commit("setGlobalState", payload);
          commit("emitGlobalState", payload);
        },
        // 初始化，只用于mount时同步父应用的数据
        initGlobalState({ commit }, payload) {
          commit("setGlobalState", payload);
        },
      },
      mutations: {
        setGlobalState(state, payload) {
          // eslint-disable-next-line
          state = Object.assign(state, payload);
        },
        // 通知父应用
        emitGlobalState(state) {
          if (props.setGlobalState) {
            props.setGlobalState(state);
          }
        },
      },
    };
    store.registerModule("global", globalModule);
  } else {
    // 每次mount时，都同步一次父应用数据
    store.dispatch("global/initGlobalState", initState);
  }
}

export default registerGlobalModule;
```

2. 在`main.js`中引入

```js
export async function mount(props) {
  console.log("[vue] props from main framework", props);
  globalState(store, props);
  render(props);
}
```

### react

假设使用的是`redux`，

1. 安装`redux`和`react-redux`

```bash
npm install redux react-redux -D
```

2. 新建`src/store/globalDataRedux.js`

```js
const initGlobalData = {};
let props = null;

function globalDataRedux(state = initGlobalData, action) {
  switch (action.type) {
    case "SET_GLOBAL_DATA":
      const globalData = { ...state, ...action.data };
      if (props) {
        props.setGlobalState(globalData);
      }
      return globalData;
    default:
      if (action.props) {
        props = action.props;
        const globalData = action.props.getGlobalState && action.props.getGlobalState();
        return globalData;
      } else {
        return state;
      }
  }
}

export default globalDataRedux;
```

3. 新建`src/store/index.js`

```js
import { combineReducers, createStore } from "redux";
import globalData from "./globalDataRedux";

const rootRedux = combineReducers({
  globalData,
});

export default createStore(rootRedux);
```

4. 在`src/index.js`中引入`react-redux`

```js
// redux和react-redux关联
import { Provider } from "react-redux";

// 操作的逻辑及状态
import store from "./store/index";

function render() {
  ReactDOM.render(
    <Provider store={store}>
      <App />
    </Provider>,
    document.getElementById("root")
  );
}

/**
 * 应用每次进入都会调用 mount 方法，通常我们在这里触发应用的渲染方法
 */
export async function mount(props) {
  store.dispatch({ props });
  render();
}
```

## 使用与测试

在父应用中的某个页面写入以下内容

```vue
<p>用户信息：{{ userInfo }}</p>
<p>
  <button type="primary" @click="updateUserInfo">变更用户信息</button>
</p>

computed: {
    userInfo() {
      return this.$globalState.getGlobalState("userInfo");
    },
  },
  methods: {
    updateUserInfo() {
      this.$globalState.setGlobalState({ userInfo: { name: "joy" } });
    },
 },
```

### vue应用

在子应用中某个页面写入如下内容：

```js
<p>用户信息：{{ userInfo }}</p>
<p><button type="primary" @click="updateUserInfo">变更用户信息</button></p>
    
<script>
import { mapState, mapActions } from "vuex";
export default {
  computed: {
    ...mapState("global", {
      userInfo: (state) => state.userInfo,
    }),
  },
  methods: {
    ...mapActions("global", ["setGlobalState"]),
    updateUserInfo() {
      this.setGlobalState({ userInfo: { name: "张三" } });
    },
  },
};
</script>
```

### react应用

```js
import { Component } from "react";
import { connect } from "react-redux";
import { Typography, Button } from "antd";
const { Title } = Typography;

const mapStateToProps = (state) => {
  return {
    userInfo: state.globalData.userInfo,
  };
};

const mapDispatchProps = (dispatch) => {
  return {
    SET_USER_INFO: function (data) {
      dispatch({ type: "SET_GLOBAL_DATA", data });
    },
  };
};

class Home extends Component {
  constructor(props) {
    super(props);
    this.state = {};
  }

  render() {
    return (
      <div>
        <Title>子Sub-React页面</Title>
        <Button type='primary' onClick={() => this.goToAboutPage()}>
          跳转到About页面
        </Button>

        <p>用户信息： {JSON.stringify(this.props.userInfo)}</p>
        <p>
          变更用户信息：
          <Button type='primary' onClick={() => this.changeUserInfo()}>
            变更用户信息
          </Button>
        </p>
      </div>
    );
  }
  changeUserInfo() {
    this.props.SET_USER_INFO({ userInfo: { name: "韩梅" } });
  }

  goToAboutPage() {
    this.props.history.push("/about");
  }
}

const HomeRedux = connect(mapStateToProps, mapDispatchProps)(Home);
export default HomeRedux;

```







